#+TITLE: Project Splash - Implementation Plan
#+AUTHOR: Jian
#+DATE: [2026-02-10 Mon]
#+STARTUP: showall

* Overview
Backport the MIPI DSI display pipeline from Linux v6.10 to U-Boot v2026.04 for Allwinner T113-S.

Pipeline: DE2 Mixer → TCON Top → TCON LCD0 → DSI Controller → D-PHY → ILI9881C Panel

** Source (Linux v6.10)
- =sun6i_mipi_dsi.c= (1,262 lines) - DSI controller, register-based, no interrupts
- =phy-sun6i-mipi-dphy.c= (648 lines) - D-PHY timing and lane config
- =sun4i_tcon.c= (1,581 lines) - TCON LCD with DSI mode support
- =sun8i_tcon_top.c= (312 lines) - TCON mux/routing
- =sun8i_mixer.c= (724 lines) - DE2 mixer/blender
- =panel-ilitek-ili9881c.c= (2,072 lines) - Panel init sequences
- =sunxi-d1s-t113.dtsi= - DSI node: compatible ="allwinner,sun50i-a100-mipi-dsi"=
- =sun8i-t113s-raft-gw-argon-va.dts= - Board reference with DSI+panel

** Target (U-Boot v2026.04)
Existing U-Boot infrastructure to build upon:
- =drivers/video/mipi_dsi.c= - Generic MIPI DSI host framework
- =drivers/video/dsi_host-uclass.c= - DSI host uclass
- =include/mipi_dsi.h= - MIPI DSI structures and APIs
- =drivers/video/sunxi/sunxi_de2.c= - DE2 driver (needs DSI output path)
- =drivers/video/sunxi/lcdc.c= - TCON register programming
- =drivers/video/panel-uclass.c= - Panel DM framework

To avoid regression, please pause at after each phase so that user can test if the original features in u-boot are still working.

* Phase 1: Clock and PHY Foundation
The DSI controller and D-PHY require specific clocks and resets. These must work before any display output.

** 1.1 Verify T113-S CCU clock support for MIPI DSI
- Check U-Boot CCU driver for =CLK_BUS_MIPI_DSI=, =CLK_MIPI_DSI= support
- Add missing clock gates/dividers if needed
- Source ref: Linux =sunxi-d1s-t113.dtsi= clock assignments for DSI node

** 1.2 Backport sun6i MIPI D-PHY driver
- Port =phy-sun6i-mipi-dphy.c= to U-Boot PHY framework
- Target: =drivers/phy/allwinner/phy-sun6i-mipi-dphy.c=
- Key: TX timing parameters (HS_TRAIL, HS_PREPARE, CLK_PRE/POST/ZERO)
- Key: Analog config registers (ANA0-ANA4) for power/bias
- Strip interrupt handling, use polling/delay where needed
- Adapt from Linux =struct phy_ops= to U-Boot =struct phy_ops=

* Phase 2: Display Pipeline Drivers
The core display pipeline: DSI controller and TCON DSI-mode support.

** 2.1 Backport sun6i MIPI DSI controller driver
- Port =sun6i_mipi_dsi.c= to U-Boot
- Target: =drivers/video/sunxi/sun6i_mipi_dsi.c=
- Implement as U-Boot DSI host uclass driver
- Key registers: CTL, BASIC_CTL, INST_FUNC, PIXEL_CTL, TRANS_START
- Use U-Boot =mipi_dsi_host_ops= interface for DCS command transfer
- Strip DRM connector/encoder, replace with U-Boot display pipeline calls
- Variant support: =sun50i-a100-mipi-dsi= (has_mod_clk=true, set_mod_clk=true)

** 2.2 Add DSI output mode to TCON/LCDC
- Extend =drivers/video/sunxi/lcdc.c= for DSI timing mode
- Set =SUN4I_TCON0_CPU_IF_MODE_DSI= in TCON0 control register
- Configure TCON0 timing registers for DSI pixel clock
- Integrate TCON Top mux to route mixer0 → TCON LCD0 → DSI
- Reference: Linux =sun4i_tcon.c= TCON0 DSI-specific configuration

** 2.3 Extend DE2 driver for DSI output path
- Update =drivers/video/sunxi/sunxi_de2.c= to support DSI as output
- Ensure mixer0 framebuffer setup and blender configuration work for DSI
- Connect DE2 probe to TCON → DSI pipeline

* Phase 3: Panel and Device Tree
Panel initialization and device tree integration.

** 3.1 Backport ILI9881C panel driver
- Port =panel-ilitek-ili9881c.c= to U-Boot panel framework
- Target: =drivers/video/panel-ilitek-ili9881c.c=
- Include =hd50004c30= variant init sequence
- Implement =panel_ops= (enable, get_display_timing)
- Handle: regulator power-on, GPIO reset sequence, MIPI DCS init commands
- Mode: =MIPI_DSI_MODE_VIDEO | MIPI_DSI_MODE_LPM=, 4 data lanes

** 3.2 Add display nodes to U-Boot device tree
- Add to =sun8i-t113s-raft-gw-argon-vb.dts=:
  - Display Engine node (DE2)
  - Mixer0 node
  - TCON Top node with DSI clock output
  - TCON LCD0 node
  - DSI controller node (compatible: =allwinner,sun50i-a100-mipi-dsi=)
  - D-PHY node
  - Panel node (compatible: =ilitek,ili9881c=)
  - Endpoint graph connections (mixer→tcon_top→tcon_lcd0→dsi→panel)
- Reference: Linux =sun8i-t113s-raft-gw-argon-va.dts=

** 3.3 Enable video in board defconfig
- Enable: =CONFIG_VIDEO=, =CONFIG_VIDEO_DE2=, =CONFIG_DM_VIDEO=
- Enable: =CONFIG_DISPLAY=, =CONFIG_VIDEO_MIPI_DSI=
- Enable: =CONFIG_PHY_SUN6I_MIPI_DPHY= (new)
- Enable: =CONFIG_VIDEO_LCD_ILI9881C= (new)
- Enable: =CONFIG_SPLASH_SCREEN=, =CONFIG_BMP_16BPP= or =CONFIG_BMP_32BPP=
- Set framebuffer size and address

* Phase 4: Integration, Testing, and Validation

** 4.1 Build integration
- Add new drivers to Kconfig and Makefiles
- Resolve compile errors and missing dependencies
- Cross-compile with =source /home/jian/.scripts/setup-oe.sh=

** 4.2 Boot testing
- Flash U-Boot to board and verify:
  - [ ] DSI controller probes successfully
  - [ ] D-PHY initializes and calibrates
  - [ ] Panel receives init sequence and displays
  - [ ] Framebuffer writes appear on screen
  - [ ] Display stable until Linux handoff

** 4.3 Splash screen configuration
- Configure splash image (BMP) loading from storage
- Set =CONFIG_SPLASH_SOURCE= and boot environment
- Verify splash displays during boot

* Dependencies Graph
#+begin_example
  1.1 CCU Clocks ──┐
                    ├──→ 2.1 DSI Controller ──┐
  1.2 D-PHY ───────┘                          │
                                               ├──→ 3.2 Device Tree ──→ 4.1 Build
  2.2 TCON DSI Mode ───────────────────────────┤
                                               │
  2.3 DE2 Extension ───────────────────────────┤
                                               │
  3.1 ILI9881C Panel ─────────────────────────┘
#+end_example

* Risk Assessment
- *Clock tree*: T113-S CCU may not have full MIPI DSI clock support in U-Boot yet. Mitigation: direct register programming if DM clock driver lacks entries.
- *D-PHY timing*: Analog calibration values are silicon-specific. Mitigation: use Linux-proven values from the working driver.
- *TCON integration*: Existing =lcdc.c= may need significant changes for DSI mode. Mitigation: can add a parallel code path rather than modifying existing LVDS/RGB paths.
- *Panel init*: DCS command sequences are timing-sensitive. Mitigation: copy exact sequences from Linux driver, use conservative delays.
